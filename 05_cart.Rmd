---
title: "Phase 5: CART (Classification and Regression Trees) Model"
author: " Peter Mangoro"
date: "2025-12-04"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
    fig_caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(ggplot2)
library(dplyr)
library(rpart)
library(rpart.plot)
library(pROC)
library(caret)
library(knitr)
```

# Introduction

This document presents Phase 5: CART (Classification and Regression Trees) Model. We build a decision tree model, visualize the tree structure, analyze variable importance, and evaluate model performance.

# Load Data

```{r load-data, echo=FALSE, comment=""}
load("data_cart.RData")
cat("Dataset: ", nrow(data_cart), " observations, ", ncol(data_cart), " variables\n")
```

# Train/Test Split

```{r train-test, echo=FALSE, comment=""}
set.seed(1)
train_indices <- createDataPartition(data_cart$readmitted, 
                                     p = 0.7, 
                                     list = FALSE)

data_train_cart <- data_cart[train_indices, ]
data_test_cart <- data_cart[-train_indices, ]

cat("Training set: ", nrow(data_train_cart), " observations (70%)\n")
cat("Testing set: ", nrow(data_test_cart), " observations (30%)\n")
```

# Build CART Model

```{r build-model, comment=""}
# Build model formula
predictor_vars_cart <- setdiff(colnames(data_train_cart), "readmitted")
formula_cart <- as.formula(paste("readmitted ~", paste(predictor_vars_cart, collapse = " + ")))

# Fit the CART model
model_cart <- rpart(formula_cart,
                   data = data_train_cart,
                   method = "class",
                   parms = list(split = "gini"),
                   control = rpart.control(
                     minsplit = 20,
                     minbucket = 7,
                     cp = 0.01,
                     maxdepth = 10,
                     xval = 10
                   ))

print(model_cart)
```

# Tree Pruning

```{r prune-tree, echo=FALSE, comment=""}

# Find optimal CP
cp_table <- model_cart$cptable
optimal_cp_index <- which.min(cp_table[, "xerror"])
xerror_min <- cp_table[optimal_cp_index, "xerror"]
xerror_se <- cp_table[optimal_cp_index, "xstd"]
xerror_1se <- xerror_min + xerror_se
cp_1se_index <- which(cp_table[, "xerror"] <= xerror_1se)[1]
cp_1se <- cp_table[cp_1se_index, "CP"]

cat("1-SE Rule CP: ", cp_1se, "\n")

# Prune the tree
model_cart_final <- prune(model_cart, cp = cp_1se)

cat("Pruned tree size: ", length(unique(model_cart_final$where)), " nodes\n")
```

# Visualize Decision Tree

```{r visualize-tree, fig.cap="CART Decision Tree: Simple tree with one split based on total previous visits", echo=FALSE, comment=""}
rpart.plot(model_cart_final, 
           type = 2,
           extra = 104,
           fallen.leaves = TRUE,
           branch = 0.3,
           under = TRUE,
           cex = 0.8,
           main = "CART Decision Tree: Predicting Hospital Readmissions")
```

# Variable Importance

```{r variable-importance, echo=FALSE, comment=""}

# Extract variable importance
var_importance <- model_cart_final$variable.importance
var_importance_pct <- (var_importance / sum(var_importance)) * 100

importance_df <- data.frame(
  Variable = names(var_importance),
  Importance = as.numeric(var_importance),
  Importance_Percent = as.numeric(var_importance_pct)
) %>%
  arrange(desc(Importance))

kable(head(importance_df, 10), caption = " Most Important Variables")

# Create importance plot
p_importance <- ggplot(head(importance_df, 10), 
                      aes(x = reorder(Variable, Importance_Percent), 
                          y = Importance_Percent)) +
  geom_bar(stat = "identity", fill = "steelblue", alpha = 0.7) +
  coord_flip() +
  labs(title = "CART Model: Variable Importance",
       subtitle = "Most Important Variables",
       x = "Variable",
       y = "Importance (%)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12))
print(p_importance)
```

# Model Evaluation

```{r model-evaluation, echo=FALSE,comment=""}

# Make predictions
predictions_class_cart <- predict(model_cart_final, newdata = data_test_cart, type = "class")
predictions_prob_cart <- predict(model_cart_final, newdata = data_test_cart, type = "prob")[, "Readmitted"]

# Confusion Matrix
conf_matrix_cart <- table(Predicted = predictions_class_cart, Actual = data_test_cart$readmitted)
kable(conf_matrix_cart, caption = "Confusion Matrix")

# Calculate metrics
actual_levels <- levels(data_test_cart$readmitted)
not_readmitted_idx <- which(actual_levels == "Not_Readmitted")
readmitted_idx <- which(actual_levels == "Readmitted")

TN <- conf_matrix_cart[not_readmitted_idx, not_readmitted_idx]
FP <- conf_matrix_cart[readmitted_idx, not_readmitted_idx]
FN <- conf_matrix_cart[not_readmitted_idx, readmitted_idx]
TP <- conf_matrix_cart[readmitted_idx, readmitted_idx]

accuracy_cart <- (TP + TN) / (TP + TN + FP + FN)
precision_cart <- TP / (TP + FP)
recall_cart <- TP / (TP + FN)
specificity_cart <- TN / (TN + FP)
f1_score_cart <- 2 * (precision_cart * recall_cart) / (precision_cart + recall_cart)

metrics_table_cart <- data.frame(
  Metric = c("Accuracy", "Precision", "Recall (Sensitivity)", "Specificity", "F1-Score"),
  Value = c(accuracy_cart, precision_cart, recall_cart, specificity_cart, f1_score_cart),
  Percentage = c(accuracy_cart * 100, precision_cart * 100, recall_cart * 100, 
                 specificity_cart * 100, f1_score_cart * 100)
)

kable(metrics_table_cart, caption = "CART Model Performance Metrics", digits = 2)
```

# ROC Curve

```{r roc-curve, fig.cap="ROC Curve: CART Model", echo=FALSE, comment=""}
roc_obj_cart <- roc(data_test_cart$readmitted, predictions_prob_cart)
auc_value_cart <- auc(roc_obj_cart)

cat("Area Under the Curve (AUC): ", round(as.numeric(auc_value_cart), 4), "\n")

# Create ROC plot
roc_data_cart <- data.frame(
  FPR = 1 - roc_obj_cart$specificities,
  TPR = roc_obj_cart$sensitivities
)

p_roc_cart <- ggplot(roc_data_cart, aes(x = FPR, y = TPR)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red", linewidth = 1) +
  labs(title = "ROC Curve: CART Model",
       subtitle = paste("AUC =", round(as.numeric(auc_value_cart), 4)),
       x = "False Positive Rate (1 - Specificity)",
       y = "True Positive Rate (Sensitivity)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 12))
print(p_roc_cart)
```

# Summary

```{r summary, echo=FALSE, comment="", results='asis'}
# Calculate summary statistics dynamically
# Accuracy (already calculated in model-evaluation chunk)
# AUC (already calculated in roc-curve chunk)

# Tree complexity
n_nodes <- length(unique(model_cart_final$where))
n_splits <- n_nodes - 1

# Top predictor (from variable importance)
if(nrow(importance_df) > 0) {
  top_predictor_cart <- importance_df$Variable[1]
  top_predictor_importance <- round(importance_df$Importance_Percent[1], 2)
  # Clean up variable name for display
  top_predictor_display_cart <- gsub("_", " ", top_predictor_cart)
} else {
  top_predictor_display_cart <- "N/A"
  top_predictor_importance <- 0
}

# Determine complexity description
if(n_splits <= 2) {
  complexity_desc <- "very simple"
} else if(n_splits <= 5) {
  complexity_desc <- "simple"
} else if(n_splits <= 10) {
  complexity_desc <- "moderate"
} else {
  complexity_desc <- "complex"
}

cat("- **Accuracy**: ", round(accuracy_cart * 100, 2), "%\n", sep = "")
cat("- **AUC**: ", round(as.numeric(auc_value_cart), 3), "\n", sep = "")
cat("- **Tree complexity**: ", n_splits, " split", ifelse(n_splits != 1, "s", ""), ", ", n_nodes, " node", ifelse(n_nodes != 1, "s", ""), " (", complexity_desc, ")\n", sep = "")
cat("- **Top predictor**: ", top_predictor_display_cart, " (", top_predictor_importance, "% importance)\n", sep = "")
cat("- **Interpretability**: ", ifelse(n_splits <= 2, "Very high", ifelse(n_splits <= 5, "High", "Moderate")), " (", complexity_desc, " decision rule", ifelse(n_splits != 1, "s", ""), ")\n", sep = "")
```


